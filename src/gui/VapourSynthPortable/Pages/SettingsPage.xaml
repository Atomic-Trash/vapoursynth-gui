<UserControl x:Class="VapourSynthPortable.Pages.SettingsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels"
             xmlns:helpers="clr-namespace:VapourSynthPortable.Helpers"
             Background="{StaticResource ContentBackground}">

    <UserControl.Resources>
        <!-- Converters -->
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <helpers:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <helpers:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <helpers:CountToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>

        <!-- Settings Page Section Header (uses primary accent, not blue) -->
        <Style x:Key="SettingsSectionHeader" TargetType="TextBlock" BasedOn="{StaticResource HeadingText}">
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
            <Setter Property="Margin" Value="0,20,0,10"/>
        </Style>

        <!-- Settings Label -->
        <Style x:Key="SettingLabel" TargetType="TextBlock" BasedOn="{StaticResource BodyText}">
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Width" Value="180"/>
        </Style>

        <!-- Settings TextBox -->
        <Style x:Key="SettingTextBox" TargetType="TextBox" BasedOn="{StaticResource FormTextBox}">
            <Setter Property="MinWidth" Value="100"/>
        </Style>

        <!-- Settings ComboBox -->
        <Style x:Key="SettingComboBox" TargetType="ComboBox" BasedOn="{StaticResource FormComboBox}">
            <Setter Property="MinWidth" Value="150"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{StaticResource SurfaceBackground}" Padding="20,15">
            <TextBlock Text="Settings" Style="{StaticResource TitleText}"/>
        </Border>

        <!-- Settings Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20">
            <StackPanel MaxWidth="600">

                <!-- Export Defaults -->
                <TextBlock Text="Export Defaults" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Default Format" Style="{StaticResource SettingLabel}"/>
                    <ComboBox ItemsSource="{Binding ExportFormats}"
                              AutomationProperties.AutomationId="DefaultFormatComboBox"
                              SelectedItem="{Binding DefaultExportFormat}"
                              Style="{StaticResource SettingComboBox}" Width="150"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Video Codec" Style="{StaticResource SettingLabel}"/>
                    <ComboBox ItemsSource="{Binding VideoCodecs}"
                              AutomationProperties.AutomationId="DefaultVideoCodecComboBox"
                              SelectedItem="{Binding DefaultVideoCodec}"
                              Style="{StaticResource SettingComboBox}" Width="150"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Audio Codec" Style="{StaticResource SettingLabel}"/>
                    <ComboBox ItemsSource="{Binding AudioCodecs}"
                              AutomationProperties.AutomationId="DefaultAudioCodecComboBox"
                              SelectedItem="{Binding DefaultAudioCodec}"
                              Style="{StaticResource SettingComboBox}" Width="150"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Video Quality (CRF)" Style="{StaticResource SettingLabel}"/>
                    <Slider Minimum="0" Maximum="51"
                            Value="{Binding DefaultVideoQuality}"
                            Style="{StaticResource FormSlider}"
                            Width="150" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding DefaultVideoQuality}" Style="{StaticResource SmallText}"
                               Margin="10,0,0,0" VerticalAlignment="Center" Width="30"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Audio Bitrate (kbps)" Style="{StaticResource SettingLabel}"/>
                    <ComboBox Width="150" Style="{StaticResource SettingComboBox}"
                              SelectedItem="{Binding DefaultAudioBitrate}">
                        <ComboBox.Items>
                            <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">128</sys:Int32>
                            <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">192</sys:Int32>
                            <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">256</sys:Int32>
                            <sys:Int32 xmlns:sys="clr-namespace:System;assembly=mscorlib">320</sys:Int32>
                        </ComboBox.Items>
                    </ComboBox>
                </StackPanel>

                <!-- Hardware Acceleration -->
                <TextBlock Text="Hardware Acceleration" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="GPU Preference" Style="{StaticResource SettingLabel}"/>
                    <ComboBox ItemsSource="{Binding GpuPreferences}"
                              SelectedItem="{Binding GpuPreference}"
                              Style="{StaticResource SettingComboBox}" Width="150"/>
                </StackPanel>

                <!-- Cache Settings -->
                <TextBlock Text="Cache" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Cache Directory" Style="{StaticResource SettingLabel}"/>
                    <TextBox Text="{Binding CacheDirectory}" Style="{StaticResource SettingTextBox}" Width="200"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Max Cache Size (MB)" Style="{StaticResource SettingLabel}"/>
                    <TextBox Text="{Binding MaxCacheSizeMB}" Style="{StaticResource SettingTextBox}" Width="100"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Current Cache Size" Style="{StaticResource SettingLabel}"/>
                    <TextBlock Text="{Binding CacheSize}" Style="{StaticResource SmallText}" VerticalAlignment="Center"/>
                    <Button Content="Clear Cache" Command="{Binding ClearCacheCommand}"
                            AutomationProperties.AutomationId="ClearCacheButton"
                            Style="{StaticResource SecondaryButtonSmall}" Margin="20,0,0,0"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Auto-clear on Exit" Style="{StaticResource SettingLabel}"/>
                    <CheckBox IsChecked="{Binding AutoClearCache}" Style="{StaticResource FormCheckBox}" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Project Settings -->
                <TextBlock Text="Projects" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Recent Projects Limit" Style="{StaticResource SettingLabel}"/>
                    <TextBox Text="{Binding RecentProjectsLimit}" Style="{StaticResource SettingTextBox}" Width="100"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Auto-save Enabled" Style="{StaticResource SettingLabel}"/>
                    <CheckBox IsChecked="{Binding AutoSaveEnabled}" Style="{StaticResource FormCheckBox}" VerticalAlignment="Center"
                              AutomationProperties.AutomationId="AutoSaveCheckbox"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Auto-save Interval (min)" Style="{StaticResource SettingLabel}"/>
                    <TextBox Text="{Binding AutoSaveIntervalMinutes}" Style="{StaticResource SettingTextBox}" Width="100"
                             IsEnabled="{Binding AutoSaveEnabled}"/>
                </StackPanel>

                <!-- UI Settings -->
                <TextBlock Text="Interface" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Show Log Panel" Style="{StaticResource SettingLabel}"/>
                    <CheckBox IsChecked="{Binding ShowLogPanel}" Style="{StaticResource FormCheckBox}" VerticalAlignment="Center"
                              AutomationProperties.AutomationId="ShowLogPanelCheckbox"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Confirm on Delete" Style="{StaticResource SettingLabel}"/>
                    <CheckBox IsChecked="{Binding ConfirmOnDelete}" Style="{StaticResource FormCheckBox}" VerticalAlignment="Center"
                              AutomationProperties.AutomationId="ConfirmOnDeleteCheckbox"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Default Timeline Zoom" Style="{StaticResource SettingLabel}"/>
                    <Slider Minimum="0.1" Maximum="5"
                            Value="{Binding TimelineZoom}"
                            Style="{StaticResource FormSlider}"
                            Width="150" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding TimelineZoom, StringFormat=F1}" Style="{StaticResource SmallText}"
                               Margin="10,0,0,0" VerticalAlignment="Center" Width="30"/>
                </StackPanel>

                <!-- VapourSynth Configuration (Read-only info) -->
                <TextBlock Text="VapourSynth Configuration" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Project Root" Style="{StaticResource SettingLabel}"/>
                    <TextBlock Text="{Binding ProjectRoot}" Style="{StaticResource SmallText}" VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis" MaxWidth="350"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Output Directory" Style="{StaticResource SettingLabel}"/>
                    <TextBox Text="{Binding OutputDirectory}" Style="{StaticResource SettingTextBox}" Width="200"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Default Plugin Set" Style="{StaticResource SettingLabel}"/>
                    <ComboBox ItemsSource="{Binding PluginSets}"
                              SelectedItem="{Binding DefaultPluginSet}"
                              Style="{StaticResource SettingComboBox}" Width="150"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Python Version" Style="{StaticResource SettingLabel}"/>
                    <TextBlock Text="{Binding PythonVersion}" Style="{StaticResource SmallText}" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="VapourSynth Version" Style="{StaticResource SettingLabel}"/>
                    <TextBlock Text="{Binding VapourSynthVersion}" Style="{StaticResource SmallText}" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Installed Plugins -->
                <TextBlock Text="Installed VapourSynth Plugins" Style="{StaticResource SettingsSectionHeader}"/>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Status" Style="{StaticResource SettingLabel}"/>
                    <TextBlock Text="{Binding PluginLoadStatus}" Style="{StaticResource SmallText}" VerticalAlignment="Center"/>
                    <Button Content="Refresh" Command="{Binding RefreshPluginsCommand}"
                            AutomationProperties.AutomationId="RefreshPluginsButton"
                            Style="{StaticResource SecondaryButtonSmall}" Margin="20,0,0,0"
                            IsEnabled="{Binding IsLoadingPlugins, Converter={StaticResource InverseBoolConverter}}"/>
                </StackPanel>

                <!-- Plugin List -->
                <Border Background="{StaticResource SurfaceBackground}" CornerRadius="{StaticResource RadiusS}"
                        Margin="0,10" Padding="10" MaxHeight="300"
                        Visibility="{Binding VapourSynthAvailable, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid>
                        <!-- Loading indicator -->
                        <TextBlock Text="Loading plugins..." Style="{StaticResource SmallText}" HorizontalAlignment="Center"
                                   Visibility="{Binding IsLoadingPlugins, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Plugin list -->
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                      Visibility="{Binding IsLoadingPlugins, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <ItemsControl ItemsSource="{Binding InstalledPlugins}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="8,6">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="100"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding Namespace}"
                                                           Foreground="{StaticResource PrimaryBrush}" FontWeight="SemiBold"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Name}"
                                                           Foreground="{StaticResource TextSecondary}" TextTrimming="CharacterEllipsis"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- No plugins message -->
                        <TextBlock Text="No plugins found" Style="{StaticResource SmallText}" HorizontalAlignment="Center"
                                   Visibility="{Binding PluginCount, Converter={StaticResource ZeroToVisibilityConverter}}"/>
                    </Grid>
                </Border>

                <!-- Not available message -->
                <TextBlock Text="VapourSynth is not installed or not configured correctly."
                           Foreground="{StaticResource ErrorBrush}" Margin="0,5"
                           Visibility="{Binding VapourSynthAvailable, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

            </StackPanel>
        </ScrollViewer>

        <!-- Footer Actions -->
        <Border Grid.Row="2" Background="{StaticResource SurfaceBackground}" Padding="20,15">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Reset to Defaults" Command="{Binding ResetToDefaultsCommand}"
                        AutomationProperties.AutomationId="ResetToDefaultsButton"
                        Style="{StaticResource SecondaryButton}" Margin="0,0,10,0"/>
                <Button Content="Cancel" Command="{Binding CancelCommand}"
                        AutomationProperties.AutomationId="CancelButton"
                        Style="{StaticResource SecondaryButton}" Margin="0,0,10,0"/>
                <Button Content="Save Settings" Command="{Binding SaveCommand}"
                        AutomationProperties.AutomationId="SaveSettingsButton"
                        Style="{StaticResource PrimaryButton}"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
