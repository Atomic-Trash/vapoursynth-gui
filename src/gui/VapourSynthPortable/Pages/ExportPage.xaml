<UserControl x:Class="VapourSynthPortable.Pages.ExportPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels"
             d:DataContext="{d:DesignInstance Type=vm:ExportViewModel}"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             AutomationProperties.Name="Export Page"
             AutomationProperties.HelpText="Render and export final video"
             KeyboardNavigation.TabNavigation="Cycle"
             KeyboardNavigation.DirectionalNavigation="Contained">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="380"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Export Settings Panel -->
        <Border Grid.Column="0" Background="#252526" Margin="10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="20">
                    <TextBlock Text="Export Settings" FontSize="16" FontWeight="SemiBold"
                               Foreground="#F1F1F1" Margin="0,0,0,20"/>

                    <!-- Input File -->
                    <TextBlock Text="INPUT FILE" Foreground="#F1F1F1" FontSize="11" Margin="0,0,0,8"/>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Text="{Binding InputPath, UpdateSourceTrigger=PropertyChanged}"
                                 AutomationProperties.AutomationId="InputPathTextBox"
                                 Padding="10,8" Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="..." Width="35"
                                AutomationProperties.AutomationId="BrowseInputButton"
                                ToolTip="Browse for input file"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseInputCommand}"/>
                    </Grid>

                    <!-- Input Info -->
                    <TextBlock Text="{Binding InputInfo}" Foreground="#AAA" FontSize="10" Margin="0,0,0,15"
                               Visibility="{Binding InputInfo, Converter={StaticResource StringToVis}}"/>

                    <!-- Preset Selection -->
                    <TextBlock Text="PRESET" Foreground="#F1F1F1" FontSize="11" Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding Presets}"
                              AutomationProperties.AutomationId="PresetComboBox"
                              SelectedItem="{Binding SelectedPreset}"
                              DisplayMemberPath="Name"
                              Margin="0,0,0,5"/>
                    <TextBlock Text="{Binding SelectedPreset.Description}" Foreground="#AAA" FontSize="10"
                               Margin="0,0,0,15" TextWrapping="Wrap"/>

                    <!-- Export Mode Selection -->
                    <TextBlock Text="EXPORT MODE" Foreground="#F1F1F1" FontSize="11" Margin="0,0,0,8"/>
                    <StackPanel Margin="0,0,0,5">
                        <RadioButton Content="Direct Encode" GroupName="ExportMode"
                                     AutomationProperties.AutomationId="DirectEncodeRadio"
                                     IsChecked="{Binding IsDirectEncodeMode}"
                                     Foreground="#F1F1F1" Margin="0,0,0,5">
                            <RadioButton.ToolTip>
                                <ToolTip Content="Encode source file directly with FFmpeg. Best for simple format conversion."/>
                            </RadioButton.ToolTip>
                        </RadioButton>
                        <RadioButton Content="Timeline with Effects" GroupName="ExportMode"
                                     AutomationProperties.AutomationId="TimelineWithEffectsRadio"
                                     IsChecked="{Binding IsTimelineWithEffectsMode}"
                                     IsEnabled="{Binding IsVapourSynthAvailable}"
                                     Foreground="#F1F1F1" Margin="0,0,0,5">
                            <RadioButton.ToolTip>
                                <ToolTip Content="Process timeline through VapourSynth with all effects applied. Requires VapourSynth."/>
                            </RadioButton.ToolTip>
                        </RadioButton>
                    </StackPanel>
                    <!-- Timeline mode warning when VS not available -->
                    <TextBlock Text="âš  VapourSynth not available - Timeline mode disabled"
                               Foreground="#FFA500" FontSize="10" Margin="0,0,0,10"
                               Visibility="{Binding IsVapourSynthAvailable, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                    <!-- Timeline mode info when active -->
                    <TextBlock Text="Effects and timeline edits will be applied during export"
                               Foreground="#6366F1" FontSize="10" Margin="0,0,0,10"
                               Visibility="{Binding IsTimelineWithEffectsMode, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <!-- Format -->
                    <TextBlock Text="FORMAT" Foreground="#F1F1F1" FontSize="11" Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding Formats}"
                              AutomationProperties.AutomationId="FormatComboBox"
                              SelectedItem="{Binding SelectedFormat}"
                              Margin="0,0,0,20"/>

                    <!-- Video Settings -->
                    <Border BorderBrush="#4A4A4A" BorderThickness="0,2,0,0" Padding="0,15,0,0" Margin="0,0,0,15">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <TextBlock Text="&#xE714;" FontFamily="Segoe MDL2 Assets"
                                           Foreground="#6366F1" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <CheckBox IsChecked="{Binding VideoEnabled}" Margin="0,0,10,0"/>
                                <TextBlock Text="VIDEO" Foreground="#F1F1F1" FontSize="12" FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel IsEnabled="{Binding VideoEnabled}">
                                <TextBlock Text="Codec" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding VideoCodecs}"
                                          AutomationProperties.AutomationId="VideoCodecComboBox"
                                          SelectedItem="{Binding SelectedVideoCodec}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Quality (CRF)" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>
                                    <Slider Grid.Column="0" Minimum="0" Maximum="51"
                                            AutomationProperties.AutomationId="QualitySlider"
                                            Value="{Binding Quality}" VerticalAlignment="Center"
                                            ToolTip="CRF value: lower = better quality but larger files"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Quality}"
                                               Foreground="#CCC" HorizontalAlignment="Right"
                                               VerticalAlignment="Center"/>
                                </Grid>
                                <TextBlock Foreground="#AAA" FontSize="9" Margin="0,0,0,10">
                                    <Run Text="Lower = better quality (0-18 lossless, 18-28 high quality, 28+ medium)"/>
                                </TextBlock>

                                <TextBlock Text="Preset (Speed)" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding PresetSpeeds}"
                                          SelectedItem="{Binding SelectedPresetSpeed}"
                                          Margin="0,0,0,10"/>

                                <!-- NVENC Hardware Preset (visible only for NVENC codecs) -->
                                <StackPanel Visibility="{Binding IsNvencCodec, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock Text="NVENC Quality Preset" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                    <ComboBox ItemsSource="{Binding NvencPresets}"
                                              AutomationProperties.AutomationId="NvencPresetComboBox"
                                              SelectedItem="{Binding SelectedNvencPreset}"
                                              Margin="0,0,0,5"/>
                                    <TextBlock Foreground="#AAA" FontSize="9" Margin="0,0,0,10">
                                        <Run Text="p1=fastest, p7=best quality. Requires NVIDIA GPU."/>
                                    </TextBlock>
                                </StackPanel>

                                <!-- ProRes Profile (visible only for ProRes codec) -->
                                <StackPanel Visibility="{Binding IsProresCodec, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock Text="ProRes Profile" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                    <ComboBox ItemsSource="{Binding ProresProfiles}"
                                              AutomationProperties.AutomationId="ProresProfileComboBox"
                                              SelectedItem="{Binding SelectedProresProfile}"
                                              Margin="0,0,0,5"/>
                                    <TextBlock Foreground="#AAA" FontSize="9" Margin="0,0,0,10">
                                        <Run Text="Higher profiles = better quality, larger files"/>
                                    </TextBlock>
                                </StackPanel>

                                <TextBlock Text="Resolution" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding Resolutions}"
                                          AutomationProperties.AutomationId="ResolutionComboBox"
                                          SelectedItem="{Binding SelectedResolution}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Frame Rate" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding FrameRates}"
                                          SelectedItem="{Binding SelectedFrameRate}"
                                          Margin="0,0,0,10"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Audio Settings -->
                    <Border BorderBrush="#4A4A4A" BorderThickness="0,2,0,0" Padding="0,15,0,0" Margin="0,0,0,15">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <TextBlock Text="&#xE767;" FontFamily="Segoe MDL2 Assets"
                                           Foreground="#6366F1" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <CheckBox IsChecked="{Binding AudioEnabled}" Margin="0,0,10,0"/>
                                <TextBlock Text="AUDIO" Foreground="#F1F1F1" FontSize="12" FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel IsEnabled="{Binding AudioEnabled}">
                                <TextBlock Text="Codec" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding AudioCodecs}"
                                          AutomationProperties.AutomationId="AudioCodecComboBox"
                                          SelectedItem="{Binding SelectedAudioCodec}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Bitrate (kbps)" Foreground="#CCC" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding AudioBitrates}"
                                          AutomationProperties.AutomationId="AudioBitrateComboBox"
                                          SelectedItem="{Binding SelectedAudioBitrate}"
                                          Margin="0,0,0,10"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Output File -->
                    <TextBlock Text="OUTPUT" Foreground="#F1F1F1" FontSize="11" Margin="0,0,0,8"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Text="{Binding OutputFileName, UpdateSourceTrigger=PropertyChanged}"
                                 AutomationProperties.AutomationId="OutputFileNameTextBox"
                                 Padding="10,8" Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="..." Width="35"
                                AutomationProperties.AutomationId="BrowseOutputButton"
                                ToolTip="Browse for output location"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseOutputCommand}"/>
                    </Grid>

                    <TextBlock Text="{Binding OutputPath}" Foreground="#9E9E9E" FontSize="9"
                               TextTrimming="CharacterEllipsis" Margin="0,0,0,15"
                               ToolTip="{Binding OutputPath}"/>

                    <!-- Estimated Size -->
                    <Border Background="#1E1E1E" CornerRadius="4" Padding="12,10" Margin="0,0,0,20"
                            Visibility="{Binding EstimatedSize, Converter={StaticResource StringToVis}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Estimated Size:" Foreground="#AAA"/>
                            <TextBlock Text="{Binding EstimatedSize}" Foreground="#CCC" FontWeight="SemiBold" Margin="8,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Action Buttons -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="0" Content="Add to Queue"
                                AutomationProperties.AutomationId="AddToQueueButton"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding AddToQueueCommand}"
                                Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="Export Now"
                                AutomationProperties.AutomationId="ExportNowButton"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding StartExportCommand}"
                                IsEnabled="{Binding IsEncoding, Converter={StaticResource InverseBool}}"
                                Margin="5,0,0,0"/>
                    </Grid>

                    <!-- Cancel Button -->
                    <Button Content="Cancel Export" Margin="0,10,0,0"
                            AutomationProperties.AutomationId="CancelExportButton"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding CancelExportCommand}"
                            Visibility="{Binding IsEncoding, Converter={StaticResource BoolToVisibility}}"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Right Panel: Progress & Queue -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="200"/>
            </Grid.RowDefinitions>

            <!-- Current Progress -->
            <Border Grid.Row="0" Background="#252526" Margin="0,10,10,5" CornerRadius="8" Padding="20">
                <StackPanel>
                    <TextBlock Text="Current Export" FontSize="14" FontWeight="SemiBold"
                               Foreground="#F1F1F1" Margin="0,0,0,15"/>

                    <!-- Progress Info -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="{Binding CurrentJob.Name, FallbackValue='No export in progress'}"
                                   Foreground="#CCC" FontSize="12"/>
                        <TextBlock Grid.Column="1" Text="{Binding StatusText}" Foreground="#AAA"/>
                    </Grid>

                    <!-- Progress Bar -->
                    <ProgressBar Value="{Binding CurrentJob.Progress, FallbackValue=0}"
                                 Maximum="100" Height="8" Margin="0,0,0,10"/>

                    <!-- Stats -->
                    <Grid Visibility="{Binding IsEncoding, Converter={StaticResource BoolToVisibility}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="FPS" Foreground="#AAA" FontSize="10"/>
                            <TextBlock Text="{Binding CurrentJob.Fps, StringFormat={}{0:F1}}"
                                       Foreground="#CCC" FontSize="14"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Speed" Foreground="#AAA" FontSize="10"/>
                            <TextBlock Foreground="#CCC" FontSize="14">
                                <Run Text="{Binding CurrentJob.Speed, StringFormat={}{0:F2}, Mode=OneWay}"/><Run Text="x"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Bitrate" Foreground="#AAA" FontSize="10"/>
                            <TextBlock Foreground="#CCC" FontSize="14">
                                <Run Text="{Binding CurrentJob.Bitrate, StringFormat={}{0:F0}, Mode=OneWay}"/><Run Text=" kb/s"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Grid.Column="3">
                            <TextBlock Text="ETA" Foreground="#AAA" FontSize="10"/>
                            <TextBlock Text="{Binding CurrentJob.TimeRemaining}"
                                       Foreground="#CCC" FontSize="14"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Export Queue -->
            <Border Grid.Row="1" Background="#252526" Margin="0,5,10,5" CornerRadius="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Queue Header -->
                    <Border Grid.Row="0" Background="#2D2D2D" Padding="15,10" CornerRadius="8,8,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="Export Queue" FontWeight="SemiBold" Foreground="#F1F1F1"/>
                                <TextBlock Foreground="#9E9E9E" Margin="10,0,0,0">
                                    <Run Text="("/>
                                    <Run Text="{Binding ExportQueue.Count, Mode=OneWay}"/>
                                    <Run Text=" items)"/>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Start Queue" Style="{StaticResource SecondaryButton}"
                                        AutomationProperties.AutomationId="StartQueueButton"
                                        Command="{Binding StartQueueCommand}" Padding="10,5"
                                        IsEnabled="{Binding IsEncoding, Converter={StaticResource InverseBool}}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Clear" Style="{StaticResource SecondaryButton}"
                                        AutomationProperties.AutomationId="ClearQueueButton"
                                        Command="{Binding ClearQueueCommand}" Padding="10,5"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Queue List -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding ExportQueue}"
                             AutomationProperties.AutomationId="ExportQueueList"
                             Background="Transparent" BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#2D2D2D" CornerRadius="4" Margin="10,5" Padding="12,10">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Status Icon -->
                                        <TextBlock Grid.Column="0" Text="{Binding StatusIcon}"
                                                   FontFamily="Segoe MDL2 Assets"
                                                   Foreground="{Binding StatusColor}"
                                                   VerticalAlignment="Center" Margin="0,0,12,0"/>

                                        <!-- Job Info -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Name}" Foreground="#CCC"/>
                                            <TextBlock Text="{Binding StatusText}" Foreground="#9E9E9E" FontSize="10"/>
                                        </StackPanel>

                                        <!-- Progress -->
                                        <ProgressBar Grid.Column="2" Value="{Binding Progress}"
                                                     Maximum="100" Width="80" Height="6"
                                                     VerticalAlignment="Center" Margin="10,0"/>

                                        <!-- Remove Button -->
                                        <Button Grid.Column="3" Content="&#xE711;"
                                                FontFamily="Segoe MDL2 Assets"
                                                Style="{StaticResource SecondaryButton}"
                                                Padding="6,4"
                                                Command="{Binding DataContext.RemoveJobCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>

                        <!-- Empty State -->
                        <ListBox.Style>
                            <Style TargetType="ListBox">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ExportQueue.Count}" Value="0">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate>
                                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                        <TextBlock Text="No exports in queue" Foreground="#9E9E9E" FontSize="12"/>
                                                        <TextBlock Text="Add files to start batch export" Foreground="#9E9E9E" FontSize="10" Margin="0,5,0,0"/>
                                                    </StackPanel>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ListBox.Style>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Log Output -->
            <Border Grid.Row="2" Background="#1E1E1E" Margin="0,5,10,10" CornerRadius="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Background="#252526" Padding="12,8" CornerRadius="8,8,0,0">
                        <Grid>
                            <TextBlock Text="Log" Foreground="#F1F1F1" FontWeight="SemiBold"/>
                            <Button Content="Clear" Style="{StaticResource SecondaryButton}"
                                    Command="{Binding ClearLogCommand}"
                                    HorizontalAlignment="Right" Padding="8,3" FontSize="10"/>
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <TextBox Text="{Binding LogOutput, Mode=OneWay}"
                                 IsReadOnly="True"
                                 Background="Transparent"
                                 Foreground="#AAA"
                                 FontFamily="Consolas"
                                 FontSize="11"
                                 BorderThickness="0"
                                 Padding="12"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"/>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
