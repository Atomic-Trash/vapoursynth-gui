<UserControl x:Class="VapourSynthPortable.Pages.ExportPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels"
             d:DataContext="{d:DesignInstance Type=vm:ExportViewModel}"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="380"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Export Settings Panel -->
        <Border Grid.Column="0" Background="#252526" Margin="10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="20">
                    <TextBlock Text="Export Settings" FontSize="16" FontWeight="SemiBold"
                               Foreground="#F1F1F1" Margin="0,0,0,20"/>

                    <!-- Input File -->
                    <TextBlock Text="INPUT FILE" Foreground="#AAA" FontSize="11" Margin="0,0,0,8"/>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Text="{Binding InputPath, UpdateSourceTrigger=PropertyChanged}"
                                 Padding="10,8" Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="..." Width="35"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseInputCommand}"/>
                    </Grid>

                    <!-- Input Info -->
                    <TextBlock Text="{Binding InputInfo}" Foreground="#888" FontSize="10" Margin="0,0,0,15"
                               Visibility="{Binding InputInfo, Converter={StaticResource StringToVis}}"/>

                    <!-- Preset Selection -->
                    <TextBlock Text="PRESET" Foreground="#AAA" FontSize="11" Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding Presets}"
                              SelectedItem="{Binding SelectedPreset}"
                              DisplayMemberPath="Name"
                              Margin="0,0,0,5"/>
                    <TextBlock Text="{Binding SelectedPreset.Description}" Foreground="#888" FontSize="10"
                               Margin="0,0,0,15" TextWrapping="Wrap"/>

                    <!-- Format -->
                    <TextBlock Text="FORMAT" Foreground="#AAA" FontSize="11" Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding Formats}"
                              SelectedItem="{Binding SelectedFormat}"
                              Margin="0,0,0,20"/>

                    <!-- Video Settings -->
                    <Border BorderBrush="#444" BorderThickness="0,1,0,0" Padding="0,15,0,0" Margin="0,0,0,15">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <CheckBox IsChecked="{Binding VideoEnabled}" Margin="0,0,10,0"/>
                                <TextBlock Text="VIDEO" Foreground="#AAA" FontSize="12" FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel IsEnabled="{Binding VideoEnabled}">
                                <TextBlock Text="Codec" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding VideoCodecs}"
                                          SelectedItem="{Binding SelectedVideoCodec}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Quality (CRF)" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                    </Grid.ColumnDefinitions>
                                    <Slider Grid.Column="0" Minimum="0" Maximum="51"
                                            Value="{Binding Quality}" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Quality}"
                                               Foreground="#CCC" HorizontalAlignment="Right"
                                               VerticalAlignment="Center"/>
                                </Grid>
                                <TextBlock Foreground="#555" FontSize="9" Margin="0,0,0,10">
                                    <Run Text="Lower = better quality, larger file (18-28 recommended)"/>
                                </TextBlock>

                                <TextBlock Text="Preset (Speed)" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding PresetSpeeds}"
                                          SelectedItem="{Binding SelectedPresetSpeed}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Resolution" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding Resolutions}"
                                          SelectedItem="{Binding SelectedResolution}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Frame Rate" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding FrameRates}"
                                          SelectedItem="{Binding SelectedFrameRate}"
                                          Margin="0,0,0,10"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Audio Settings -->
                    <Border BorderBrush="#444" BorderThickness="0,1,0,0" Padding="0,15,0,0" Margin="0,0,0,15">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <CheckBox IsChecked="{Binding AudioEnabled}" Margin="0,0,10,0"/>
                                <TextBlock Text="AUDIO" Foreground="#AAA" FontSize="12" FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel IsEnabled="{Binding AudioEnabled}">
                                <TextBlock Text="Codec" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding AudioCodecs}"
                                          SelectedItem="{Binding SelectedAudioCodec}"
                                          Margin="0,0,0,10"/>

                                <TextBlock Text="Bitrate (kbps)" Foreground="#AAA" FontSize="10" Margin="0,0,0,5"/>
                                <ComboBox ItemsSource="{Binding AudioBitrates}"
                                          SelectedItem="{Binding SelectedAudioBitrate}"
                                          Margin="0,0,0,10"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Output File -->
                    <TextBlock Text="OUTPUT" Foreground="#AAA" FontSize="11" Margin="0,0,0,8"/>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" Text="{Binding OutputFileName, UpdateSourceTrigger=PropertyChanged}"
                                 Padding="10,8" Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="..." Width="35"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseOutputCommand}"/>
                    </Grid>

                    <TextBlock Text="{Binding OutputPath}" Foreground="#555" FontSize="9"
                               TextTrimming="CharacterEllipsis" Margin="0,0,0,15"
                               ToolTip="{Binding OutputPath}"/>

                    <!-- Estimated Size -->
                    <Border Background="#1E1E1E" CornerRadius="4" Padding="12,10" Margin="0,0,0,20"
                            Visibility="{Binding EstimatedSize, Converter={StaticResource StringToVis}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Estimated Size:" Foreground="#AAA"/>
                            <TextBlock Text="{Binding EstimatedSize}" Foreground="#CCC" FontWeight="SemiBold" Margin="8,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Action Buttons -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="0" Content="Add to Queue"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding AddToQueueCommand}"
                                Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="Export Now"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding StartExportCommand}"
                                IsEnabled="{Binding IsEncoding, Converter={StaticResource InverseBool}}"
                                Margin="5,0,0,0"/>
                    </Grid>

                    <!-- Cancel Button -->
                    <Button Content="Cancel Export" Margin="0,10,0,0"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding CancelExportCommand}"
                            Visibility="{Binding IsEncoding, Converter={StaticResource BoolToVisibility}}"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Right Panel: Progress & Queue -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="200"/>
            </Grid.RowDefinitions>

            <!-- Current Progress -->
            <Border Grid.Row="0" Background="#252526" Margin="0,10,10,5" CornerRadius="8" Padding="20">
                <StackPanel>
                    <TextBlock Text="Current Export" FontSize="14" FontWeight="SemiBold"
                               Foreground="#F1F1F1" Margin="0,0,0,15"/>

                    <!-- Progress Info -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="{Binding CurrentJob.Name, FallbackValue='No export in progress'}"
                                   Foreground="#CCC" FontSize="12"/>
                        <TextBlock Grid.Column="1" Text="{Binding StatusText}" Foreground="#AAA"/>
                    </Grid>

                    <!-- Progress Bar -->
                    <ProgressBar Value="{Binding CurrentJob.Progress, FallbackValue=0}"
                                 Maximum="100" Height="8" Margin="0,0,0,10"/>

                    <!-- Stats -->
                    <Grid Visibility="{Binding IsEncoding, Converter={StaticResource BoolToVisibility}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="FPS" Foreground="#888" FontSize="10"/>
                            <TextBlock Text="{Binding CurrentJob.Fps, StringFormat={}{0:F1}}"
                                       Foreground="#CCC" FontSize="14"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Speed" Foreground="#888" FontSize="10"/>
                            <TextBlock Foreground="#CCC" FontSize="14">
                                <Run Text="{Binding CurrentJob.Speed, StringFormat={}{0:F2}, Mode=OneWay}"/><Run Text="x"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Bitrate" Foreground="#888" FontSize="10"/>
                            <TextBlock Foreground="#CCC" FontSize="14">
                                <Run Text="{Binding CurrentJob.Bitrate, StringFormat={}{0:F0}, Mode=OneWay}"/><Run Text=" kb/s"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Grid.Column="3">
                            <TextBlock Text="ETA" Foreground="#888" FontSize="10"/>
                            <TextBlock Text="{Binding CurrentJob.TimeRemaining}"
                                       Foreground="#CCC" FontSize="14"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Export Queue -->
            <Border Grid.Row="1" Background="#252526" Margin="0,5,10,5" CornerRadius="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Queue Header -->
                    <Border Grid.Row="0" Background="#2D2D2D" Padding="15,10" CornerRadius="8,8,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="Export Queue" FontWeight="SemiBold" Foreground="#F1F1F1"/>
                                <TextBlock Foreground="#888" Margin="10,0,0,0">
                                    <Run Text="("/>
                                    <Run Text="{Binding ExportQueue.Count, Mode=OneWay}"/>
                                    <Run Text=" items)"/>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Start Queue" Style="{StaticResource SecondaryButton}"
                                        Command="{Binding StartQueueCommand}" Padding="10,5"
                                        IsEnabled="{Binding IsEncoding, Converter={StaticResource InverseBool}}"
                                        Margin="0,0,8,0"/>
                                <Button Content="Clear" Style="{StaticResource SecondaryButton}"
                                        Command="{Binding ClearQueueCommand}" Padding="10,5"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Queue List -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding ExportQueue}"
                             Background="Transparent" BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#2D2D2D" CornerRadius="4" Margin="10,5" Padding="12,10">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Status Icon -->
                                        <TextBlock Grid.Column="0" Text="{Binding StatusIcon}"
                                                   FontFamily="Segoe MDL2 Assets"
                                                   Foreground="{Binding StatusColor}"
                                                   VerticalAlignment="Center" Margin="0,0,12,0"/>

                                        <!-- Job Info -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Name}" Foreground="#CCC"/>
                                            <TextBlock Text="{Binding StatusText}" Foreground="#888" FontSize="10"/>
                                        </StackPanel>

                                        <!-- Progress -->
                                        <ProgressBar Grid.Column="2" Value="{Binding Progress}"
                                                     Maximum="100" Width="80" Height="6"
                                                     VerticalAlignment="Center" Margin="10,0"/>

                                        <!-- Remove Button -->
                                        <Button Grid.Column="3" Content="&#xE711;"
                                                FontFamily="Segoe MDL2 Assets"
                                                Style="{StaticResource SecondaryButton}"
                                                Padding="6,4"
                                                Command="{Binding DataContext.RemoveJobCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>

                        <!-- Empty State -->
                        <ListBox.Style>
                            <Style TargetType="ListBox">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ExportQueue.Count}" Value="0">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate>
                                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                        <TextBlock Text="No exports in queue" Foreground="#555" FontSize="12"/>
                                                        <TextBlock Text="Add files to start batch export" Foreground="#444" FontSize="10" Margin="0,5,0,0"/>
                                                    </StackPanel>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ListBox.Style>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Log Output -->
            <Border Grid.Row="2" Background="#1E1E1E" Margin="0,5,10,10" CornerRadius="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Background="#252526" Padding="12,8" CornerRadius="8,8,0,0">
                        <Grid>
                            <TextBlock Text="Log" Foreground="#AAA" FontWeight="SemiBold"/>
                            <Button Content="Clear" Style="{StaticResource SecondaryButton}"
                                    Command="{Binding ClearLogCommand}"
                                    HorizontalAlignment="Right" Padding="8,3" FontSize="10"/>
                        </Grid>
                    </Border>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <TextBox Text="{Binding LogOutput, Mode=OneWay}"
                                 IsReadOnly="True"
                                 Background="Transparent"
                                 Foreground="#AAA"
                                 FontFamily="Consolas"
                                 FontSize="11"
                                 BorderThickness="0"
                                 Padding="12"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"/>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
