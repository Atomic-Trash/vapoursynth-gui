<UserControl x:Class="VapourSynthPortable.Controls.TimelineControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:VapourSynthPortable.Models"
             xmlns:controls="clr-namespace:VapourSynthPortable.Controls"
             Background="#1A1A1A">

    <UserControl.Resources>
        <!-- Converter to check if clip is audio -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <!-- Text Overlay Template -->
        <DataTemplate x:Key="TextOverlayTemplate" DataType="{x:Type models:TimelineTextOverlay}">
            <Border x:Name="OverlayBorder"
                    Background="#7B68EE" BorderBrush="#222" BorderThickness="1" CornerRadius="3"
                    Margin="1,4" Cursor="Hand" MinWidth="30">
                <Grid>
                    <!-- Text preview -->
                    <TextBlock Text="{Binding Text}" Foreground="#FFF" FontSize="10"
                               VerticalAlignment="Center" HorizontalAlignment="Center"
                               TextTrimming="CharacterEllipsis" Margin="6,2"
                               ToolTip="{Binding Text}"/>

                    <!-- Selection indicator -->
                    <Border BorderBrush="#FFF" BorderThickness="2" CornerRadius="3"
                            Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Clip Template -->
        <DataTemplate x:Key="ClipTemplate" DataType="{x:Type models:TimelineClip}">
            <Border x:Name="ClipBorder"
                    Background="{Binding Color, Converter={StaticResource ColorToBrushConverter}}"
                    BorderBrush="#222" BorderThickness="1" CornerRadius="3"
                    Margin="1,2" Cursor="Hand" MinWidth="20">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="6"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="6"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left trim handle -->
                    <Border Grid.Column="0" Background="#40000000" Cursor="SizeWE"
                            MouseLeftButtonDown="TrimHandle_LeftMouseDown"/>

                    <!-- Clip content -->
                    <Grid Grid.Column="1" Margin="0,2">
                        <!-- Audio waveform (shown for audio clips) -->
                        <controls:AudioWaveformControl
                            SourcePath="{Binding SourcePath}"
                            WaveformColor="{Binding Color}"
                            Visibility="{Binding IsAudio, Converter={StaticResource BoolToVisibilityConverter}}"
                            Margin="0,10,0,2"/>

                        <!-- Video thumbnail placeholder (shown for video clips) -->
                        <Border Background="#20000000"
                                Visibility="{Binding IsVideo, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="0,10,0,2"/>

                        <!-- Clip name label -->
                        <TextBlock Text="{Binding Name}" Foreground="#FFF" FontSize="10"
                                   VerticalAlignment="Top" HorizontalAlignment="Left"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTip="{Binding Name}" Margin="4,0,0,0"/>
                    </Grid>

                    <!-- Right trim handle -->
                    <Border Grid.Column="2" Background="#40000000" Cursor="SizeWE"
                            MouseLeftButtonDown="TrimHandle_RightMouseDown"/>

                    <!-- Selection indicator -->
                    <Border Grid.ColumnSpan="3" BorderBrush="#FFF" BorderThickness="2"
                            CornerRadius="3" Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <!-- Muted overlay -->
                    <Border Grid.ColumnSpan="3" Background="#80000000" CornerRadius="3"
                            Visibility="{Binding IsMuted, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Text="MUTED" Foreground="#AAA" FontSize="9"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="28"/>
            <RowDefinition Height="32"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="120"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Track Headers Area -->
        <Border Grid.Row="0" Grid.Column="0" Background="#2A2A2A" BorderBrush="#333" BorderThickness="0,0,1,1">
            <Grid>
                <TextBlock Text="Tracks" Foreground="#888" FontSize="11"
                           VerticalAlignment="Center" Margin="10,0"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,5,0">
                    <Button x:Name="AddVideoTrackButton" Content="V+" ToolTip="Add Video Track"
                            Width="22" Height="20" FontSize="9" Background="#333" Foreground="#AAA"
                            BorderThickness="0" Cursor="Hand" Click="AddVideoTrack_Click"/>
                    <Button x:Name="AddAudioTrackButton" Content="A+" ToolTip="Add Audio Track"
                            Width="22" Height="20" FontSize="9" Background="#333" Foreground="#AAA"
                            BorderThickness="0" Cursor="Hand" Margin="2,0,0,0" Click="AddAudioTrack_Click"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Timeline Ruler -->
        <Border Grid.Row="0" Grid.Column="1" Background="#2A2A2A" BorderBrush="#333" BorderThickness="0,0,0,1">
            <Canvas x:Name="RulerCanvas" ClipToBounds="True"
                    MouseLeftButtonDown="Ruler_MouseLeftButtonDown"/>
        </Border>

        <!-- Text Overlay Track Header -->
        <Border Grid.Row="1" Grid.Column="0" Background="#2D2D2D" BorderBrush="#333" BorderThickness="0,0,1,1">
            <Grid>
                <Border Background="#483D8B" Width="35" HorizontalAlignment="Left">
                    <TextBlock Text="T" Foreground="#FFF" FontSize="11" FontWeight="SemiBold"
                               VerticalAlignment="Center" HorizontalAlignment="Center"
                               ToolTip="Text Overlays"/>
                </Border>
                <TextBlock Text="Text" Foreground="#AAA" FontSize="10" Margin="45,0,0,0"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Text Overlay Track Content -->
        <Border Grid.Row="1" Grid.Column="1" Background="#252530" BorderBrush="#333" BorderThickness="0,0,0,1">
            <Canvas x:Name="TextOverlayCanvas" ClipToBounds="True"
                    MouseLeftButtonDown="TextOverlay_MouseLeftButtonDown">
                <ItemsControl x:Name="TextOverlaysContainer" ItemsSource="{Binding TextOverlays}"
                              ItemTemplate="{StaticResource TextOverlayTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding StartFrame, Converter={StaticResource FrameToPixelConverter}}"/>
                            <Setter Property="Width" Value="{Binding DurationFrames, Converter={StaticResource FrameToPixelConverter}}"/>
                            <Setter Property="Height" Value="24"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                </ItemsControl>
            </Canvas>
        </Border>

        <!-- Track Headers -->
        <ScrollViewer Grid.Row="2" Grid.Column="0"
                      x:Name="TrackHeaderScrollViewer"
                      VerticalScrollBarVisibility="Hidden"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl x:Name="TrackHeaders" ItemsSource="{Binding Tracks}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:TimelineTrack}">
                        <Border Background="#2D2D2D" BorderBrush="#333" BorderThickness="0,0,1,1"
                                Height="{Binding Height}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Track name -->
                                <Border Grid.Column="0" Background="#383838" Width="35" Margin="0,0,5,0">
                                    <TextBlock Text="{Binding Name}" Foreground="#CCC" FontSize="11"
                                               FontWeight="SemiBold" VerticalAlignment="Center"
                                               HorizontalAlignment="Center"/>
                                </Border>

                                <!-- Track controls -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                    <!-- Visibility toggle (video) / Mute (audio) -->
                                    <ToggleButton x:Name="MuteToggle" IsChecked="{Binding IsMuted}"
                                                  Width="20" Height="18" Margin="2,0"
                                                  ToolTip="{Binding TrackType, Converter={StaticResource TrackTypeToMuteTooltipConverter}}"
                                                  Style="{StaticResource TrackToggleButton}">
                                        <TextBlock Text="M" FontSize="9" Foreground="#AAA"/>
                                    </ToggleButton>

                                    <!-- Solo toggle -->
                                    <ToggleButton IsChecked="{Binding IsSolo}"
                                                  Width="20" Height="18" Margin="2,0"
                                                  ToolTip="Solo" Style="{StaticResource TrackToggleButton}">
                                        <TextBlock Text="S" FontSize="9" Foreground="#AAA"/>
                                    </ToggleButton>

                                    <!-- Lock toggle -->
                                    <ToggleButton IsChecked="{Binding IsLocked}"
                                                  Width="20" Height="18" Margin="2,0"
                                                  ToolTip="Lock" Style="{StaticResource TrackToggleButton}">
                                        <TextBlock Text="L" FontSize="9" Foreground="#AAA"/>
                                    </ToggleButton>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Timeline Tracks Area -->
        <ScrollViewer Grid.Row="2" Grid.Column="1"
                      x:Name="TimelineScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      ScrollChanged="TimelineScrollViewer_ScrollChanged">
            <Grid x:Name="TimelineGrid">
                <!-- Tracks container -->
                <ItemsControl x:Name="TracksContainer" ItemsSource="{Binding Tracks}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:TimelineTrack}">
                            <Border Background="#252525" BorderBrush="#333" BorderThickness="0,0,0,1"
                                    Height="{Binding Height}" AllowDrop="True"
                                    Drop="Track_Drop" DragOver="Track_DragOver">
                                <Canvas x:Name="TrackCanvas" ClipToBounds="True">
                                    <ItemsControl ItemsSource="{Binding Clips}"
                                                  ItemTemplate="{StaticResource ClipTemplate}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="{Binding StartFrame, Converter={StaticResource FrameToPixelConverter}}"/>
                                                <Setter Property="Width" Value="{Binding DurationFrames, Converter={StaticResource FrameToPixelConverter}}"/>
                                                <Setter Property="Height" Value="46"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                    </ItemsControl>
                                </Canvas>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Playhead -->
                <Canvas x:Name="PlayheadCanvas" IsHitTestVisible="False">
                    <Line x:Name="PlayheadLine" Y1="0" Y2="1000"
                          Stroke="#FF5555" StrokeThickness="1"
                          Canvas.Left="0"/>
                    <Polygon x:Name="PlayheadHead" Fill="#FF5555"
                             Points="0,0 5,8 -5,8" Canvas.Top="-1"/>
                </Canvas>

                <!-- In/Out points -->
                <Canvas x:Name="InOutCanvas" IsHitTestVisible="False">
                    <Rectangle x:Name="InOutOverlay" Fill="#300078D4" Height="1000"
                               Visibility="Collapsed"/>
                </Canvas>
            </Grid>
        </ScrollViewer>

        <!-- Zoom control -->
        <Border Grid.Row="3" Grid.ColumnSpan="2" Background="#2A2A2A" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="Zoom:" Foreground="#888" FontSize="11"
                           VerticalAlignment="Center" Margin="0,0,10,0"/>
                <Slider Grid.Column="1" x:Name="ZoomSlider" Minimum="0.1" Maximum="5" Value="1"
                        VerticalAlignment="Center" ValueChanged="ZoomSlider_ValueChanged"/>

                <StackPanel Grid.Column="3" Orientation="Horizontal">
                    <TextBlock Text="Duration:" Foreground="#666" FontSize="10"
                               VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBlock x:Name="DurationText" Text="00:00:00:00" Foreground="#AAA" FontSize="10"
                               VerticalAlignment="Center" FontFamily="Consolas"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
