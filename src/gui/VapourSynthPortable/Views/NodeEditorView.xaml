<UserControl x:Class="VapourSynthPortable.Views.NodeEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:nodify="https://miroiu.github.io/nodify"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels.NodeEditor"
             xmlns:views="clr-namespace:VapourSynthPortable.Views">

    <UserControl.DataContext>
        <vm:NodeEditorViewModel />
    </UserControl.DataContext>

    <UserControl.Resources>
        <!-- Connector Template -->
        <DataTemplate x:Key="ConnectorTemplate" DataType="{x:Type vm:ConnectorViewModel}">
            <nodify:NodeInput x:Name="Connector"
                              Anchor="{Binding Anchor, Mode=OneWayToSource}"
                              IsConnected="{Binding IsConnected}"
                              Background="#007ACC"
                              BorderBrush="#005A9E"
                              ToolTip="{Binding Name}"/>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsInput}" Value="False">
                    <Setter TargetName="Connector" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="OutputConnectorTemplate" DataType="{x:Type vm:ConnectorViewModel}">
            <nodify:NodeOutput x:Name="Connector"
                               Anchor="{Binding Anchor, Mode=OneWayToSource}"
                               IsConnected="{Binding IsConnected}"
                               Background="#007ACC"
                               BorderBrush="#005A9E"
                               ToolTip="{Binding Name}"/>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsInput}" Value="True">
                    <Setter TargetName="Connector" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <!-- Source Node Template -->
        <DataTemplate DataType="{x:Type vm:SourceNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}">
                <StackPanel MinWidth="180" Margin="5">
                    <TextBlock Text="File:" Foreground="#999" FontSize="11"/>
                    <Grid Margin="0,4,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{Binding FilePath, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#1E1E1E" Foreground="#CCC"
                                 BorderThickness="1" BorderBrush="#3E3E42"
                                 Padding="4" FontSize="11"/>
                        <Button Grid.Column="1" Content="..."
                                Command="{Binding DataContext.BrowseSourceFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Width="25" Margin="4,0,0,0"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"/>
                    </Grid>
                    <TextBlock Text="Plugin:" Foreground="#999" FontSize="11" Margin="0,8,0,0"/>
                    <ComboBox SelectedItem="{Binding SourcePlugin}" Margin="0,4,0,0"
                              Background="#1E1E1E" Foreground="#CCC" FontSize="11">
                        <ComboBoxItem Content="ffms2"/>
                        <ComboBoxItem Content="lsmashsource"/>
                    </ComboBox>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Output Node Template -->
        <DataTemplate DataType="{x:Type vm:OutputNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}">
                <StackPanel MinWidth="100" Margin="5">
                    <TextBlock Text="Output Index:" Foreground="#999" FontSize="11"/>
                    <TextBox Text="{Binding OutputIndex, UpdateSourceTrigger=PropertyChanged}"
                             Background="#1E1E1E" Foreground="#CCC"
                             BorderThickness="1" BorderBrush="#3E3E42"
                             Padding="4" FontSize="11" Margin="0,4,0,0"/>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Filter Node Template -->
        <DataTemplate DataType="{x:Type vm:FilterNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}">
                <StackPanel MinWidth="150" Margin="5">
                    <ItemsControl ItemsSource="{Binding Parameters}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,0,0,4">
                                    <TextBlock Text="{Binding Name}" Foreground="#999" FontSize="11"/>
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                             Background="#1E1E1E" Foreground="#CCC"
                                             BorderThickness="1" BorderBrush="#3E3E42"
                                             Padding="4" FontSize="11" Margin="0,2,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Connection Style -->
        <Style TargetType="{x:Type nodify:Connection}" x:Key="ConnectionStyle">
            <Setter Property="Stroke" Value="#007ACC"/>
            <Setter Property="StrokeThickness" Value="2"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="300"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Node Palette -->
        <Border Grid.Column="0" Background="#252526" Margin="0,0,10,0" CornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Add Nodes"
                           FontSize="14" FontWeight="SemiBold"
                           Foreground="#F1F1F1"
                           Margin="15,15,15,10"/>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <!-- Source Nodes -->
                        <TextBlock Text="SOURCES" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,0,0,8"/>
                        <Button Content="Video Source"
                                Command="{Binding AddSourceNodeCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Resize Filters -->
                        <TextBlock Text="RESIZE" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="Resize (Lanczos)"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="resize"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Descale"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="descale"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="FmtConv"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="fmtconv"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Denoise Filters -->
                        <TextBlock Text="DENOISE" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="BM3D"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="bm3d"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="DFTTest"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="dfttest"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="KNLMeansCL"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="knlm"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Bilateral"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="bilateral"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Deinterlace Filters -->
                        <TextBlock Text="DEINTERLACE" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="EEDI3"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="eedi3"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="NNEDI3"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="nnedi3"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Sharpen Filters -->
                        <TextBlock Text="SHARPEN" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="CAS"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="cas"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="TCanny"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="tcanny"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Utility Filters -->
                        <TextBlock Text="UTILITY" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="Crop"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="crop"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Trim"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="trim"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Output Nodes -->
                        <TextBlock Text="OUTPUT" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="Output"
                                Command="{Binding AddOutputNodeCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Graph Actions -->
                        <TextBlock Text="GRAPH" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,20,0,8"/>
                        <Button Content="Save Graph"
                                Command="{Binding SaveGraphCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Load Graph"
                                Command="{Binding LoadGraphCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Clear Canvas"
                                Command="{Binding ClearCanvasCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Script Actions -->
                        <TextBlock Text="SCRIPT" FontSize="10" FontWeight="Bold"
                                   Foreground="#666" Margin="5,15,0,8"/>
                        <Button Content="Generate Script"
                                Command="{Binding GenerateScriptCommand}"
                                Style="{StaticResource PrimaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Save Script"
                                Command="{Binding SaveScriptCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch"/>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Center: Node Canvas -->
        <Border Grid.Column="1" Background="#1E1E1E" CornerRadius="8">
            <nodify:NodifyEditor ItemsSource="{Binding Nodes}"
                                 Connections="{Binding Connections}"
                                 SelectedItem="{Binding SelectedNode}"
                                 ConnectionCompletedCommand="{Binding ConnectionCompletedCommand}"
                                 DisconnectConnectorCommand="{Binding ConnectionCompletedCommand}"
                                 Background="#1E1E1E"
                                 GridCellSize="20">
                <nodify:NodifyEditor.ItemContainerStyle>
                    <Style TargetType="{x:Type nodify:ItemContainer}">
                        <Setter Property="Location" Value="{Binding Location, Mode=TwoWay}"/>
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                    </Style>
                </nodify:NodifyEditor.ItemContainerStyle>
                <nodify:NodifyEditor.ConnectionTemplate>
                    <DataTemplate DataType="{x:Type vm:ConnectionViewModel}">
                        <nodify:Connection Source="{Binding Source.Anchor}"
                                           Target="{Binding Target.Anchor}"
                                           Stroke="#007ACC"
                                           StrokeThickness="2"/>
                    </DataTemplate>
                </nodify:NodifyEditor.ConnectionTemplate>
                <nodify:NodifyEditor.PendingConnectionTemplate>
                    <DataTemplate>
                        <nodify:PendingConnection Stroke="#007ACC"
                                                  StrokeThickness="2"
                                                  StrokeDashArray="2 1"/>
                    </DataTemplate>
                </nodify:NodifyEditor.PendingConnectionTemplate>
            </nodify:NodifyEditor>
        </Border>

        <!-- Right Panel: Script & Preview Tabs -->
        <Border Grid.Column="2" Background="#252526" Margin="10,0,0,0" CornerRadius="8">
            <TabControl Background="Transparent" BorderThickness="0">
                <TabControl.Resources>
                    <Style TargetType="TabItem">
                        <Setter Property="Background" Value="#252526"/>
                        <Setter Property="Foreground" Value="#999"/>
                        <Setter Property="Padding" Value="12,8"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Border x:Name="Border" Background="{TemplateBinding Background}"
                                            CornerRadius="4,4,0,0" Margin="2,0,0,0">
                                        <ContentPresenter x:Name="ContentSite"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"
                                                          ContentSource="Header"
                                                          Margin="{TemplateBinding Padding}"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#1E1E1E"/>
                                            <Setter Property="Foreground" Value="#F1F1F1"/>
                                            <Setter TargetName="Border" Property="Background" Value="#1E1E1E"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#333337"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.Resources>

                <!-- Script Tab -->
                <TabItem Header="Script">
                    <Grid Background="#1E1E1E">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="#1E1E1E"
                                CornerRadius="0,0,4,4" Margin="0">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Auto">
                                <TextBox Text="{Binding GeneratedScript, Mode=OneWay}"
                                         IsReadOnly="True"
                                         Background="Transparent"
                                         Foreground="#D4D4D4"
                                         FontFamily="Consolas"
                                         FontSize="11"
                                         BorderThickness="0"
                                         Padding="10"
                                         TextWrapping="NoWrap"
                                         AcceptsReturn="True"/>
                            </ScrollViewer>
                        </Border>

                        <TextBlock Grid.Row="1"
                                   Text="{Binding StatusMessage}"
                                   Foreground="#999"
                                   FontSize="11"
                                   Margin="10,5,10,10"/>
                    </Grid>
                </TabItem>

                <!-- Preview Tab -->
                <TabItem Header="Preview">
                    <views:PreviewView x:Name="PreviewPanel"/>
                </TabItem>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
