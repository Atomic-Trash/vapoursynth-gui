<UserControl x:Class="VapourSynthPortable.Views.NodeEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:nodify="https://miroiu.github.io/nodify"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels.NodeEditor"
             xmlns:views="clr-namespace:VapourSynthPortable.Views">

    <UserControl.DataContext>
        <vm:NodeEditorViewModel />
    </UserControl.DataContext>

    <UserControl.InputBindings>
        <KeyBinding Key="Delete" Command="{Binding DeleteNodeCommand}" CommandParameter="{Binding SelectedNode}"/>
        <KeyBinding Key="D" Modifiers="Ctrl" Command="{Binding DuplicateNodeCommand}" CommandParameter="{Binding SelectedNode}"/>
        <KeyBinding Key="G" Modifiers="Ctrl" Command="{Binding GenerateScriptCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveGraphCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding LoadGraphCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}"/>
        <KeyBinding Key="Y" Modifiers="Ctrl" Command="{Binding RedoCommand}"/>
    </UserControl.InputBindings>

    <UserControl.Resources>
        <!-- Node Context Menu -->
        <ContextMenu x:Key="NodeContextMenu">
            <MenuItem Header="Duplicate" Command="{Binding DataContext.DuplicateNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding}" InputGestureText="Ctrl+D"/>
            <MenuItem Header="Delete" Command="{Binding DataContext.DeleteNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding}" InputGestureText="Del"/>
            <Separator/>
            <MenuItem Header="Disconnect All" Command="{Binding DataContext.DisconnectNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding}"/>
        </ContextMenu>
        <!-- Connector Template -->
        <DataTemplate x:Key="ConnectorTemplate" DataType="{x:Type vm:ConnectorViewModel}">
            <nodify:NodeInput x:Name="Connector"
                              Anchor="{Binding Anchor, Mode=OneWayToSource}"
                              IsConnected="{Binding IsConnected}"
                              Background="#007ACC"
                              BorderBrush="#005A9E"
                              ToolTip="{Binding Name}"/>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsInput}" Value="False">
                    <Setter TargetName="Connector" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate x:Key="OutputConnectorTemplate" DataType="{x:Type vm:ConnectorViewModel}">
            <nodify:NodeOutput x:Name="Connector"
                               Anchor="{Binding Anchor, Mode=OneWayToSource}"
                               IsConnected="{Binding IsConnected}"
                               Background="#007ACC"
                               BorderBrush="#005A9E"
                               ToolTip="{Binding Name}"/>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsInput}" Value="True">
                    <Setter TargetName="Connector" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <!-- Source Node Template -->
        <DataTemplate DataType="{x:Type vm:SourceNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}"
                         HeaderBrush="#2D7D46"
                         ContextMenu="{StaticResource NodeContextMenu}">
                <StackPanel MinWidth="180" Margin="5">
                    <TextBlock Text="File:" Foreground="#999" FontSize="11"/>
                    <Grid Margin="0,4,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{Binding FilePath, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#1E1E1E" Foreground="#CCC"
                                 BorderThickness="1" BorderBrush="#3E3E42"
                                 Padding="4" FontSize="11"/>
                        <Button Grid.Column="1" Content="..."
                                Command="{Binding DataContext.BrowseSourceFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Width="25" Margin="4,0,0,0"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"/>
                    </Grid>
                    <TextBlock Text="Plugin:" Foreground="#999" FontSize="11" Margin="0,8,0,0"/>
                    <ComboBox SelectedItem="{Binding SourcePlugin}" Margin="0,4,0,0"
                              Background="#1E1E1E" Foreground="#CCC" FontSize="11">
                        <ComboBoxItem Content="ffms2"/>
                        <ComboBoxItem Content="lsmashsource"/>
                    </ComboBox>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Output Node Template -->
        <DataTemplate DataType="{x:Type vm:OutputNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}"
                         HeaderBrush="#8B4513"
                         ContextMenu="{StaticResource NodeContextMenu}">
                <StackPanel MinWidth="100" Margin="5">
                    <TextBlock Text="Output Index:" Foreground="#999" FontSize="11"/>
                    <TextBox Text="{Binding OutputIndex, UpdateSourceTrigger=PropertyChanged}"
                             Background="#1E1E1E" Foreground="#CCC"
                             BorderThickness="1" BorderBrush="#3E3E42"
                             Padding="4" FontSize="11" Margin="0,4,0,0"/>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Filter Node Template -->
        <DataTemplate DataType="{x:Type vm:FilterNodeViewModel}">
            <nodify:Node Header="{Binding Title}"
                         Input="{Binding Input}"
                         Output="{Binding Output}"
                         InputConnectorTemplate="{StaticResource ConnectorTemplate}"
                         OutputConnectorTemplate="{StaticResource OutputConnectorTemplate}"
                         HeaderBrush="#0E639C"
                         ContextMenu="{StaticResource NodeContextMenu}">
                <StackPanel MinWidth="150" Margin="5">
                    <ItemsControl ItemsSource="{Binding Parameters}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,0,0,4">
                                    <TextBlock Text="{Binding Name}" Foreground="#999" FontSize="11"/>
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                             Background="#1E1E1E" Foreground="#CCC"
                                             BorderThickness="1" BorderBrush="#3E3E42"
                                             Padding="4" FontSize="11" Margin="0,2,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </nodify:Node>
        </DataTemplate>

        <!-- Connection Style -->
        <Style TargetType="{x:Type nodify:Connection}" x:Key="ConnectionStyle">
            <Setter Property="Stroke" Value="#007ACC"/>
            <Setter Property="StrokeThickness" Value="2"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220" MinWidth="180" MaxWidth="350"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="*" MinWidth="400"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="300" MinWidth="250" MaxWidth="500"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Node Palette -->
        <Border Grid.Column="0" Background="#252526" CornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Add Nodes"
                           FontSize="14" FontWeight="SemiBold"
                           Foreground="#F1F1F1"
                           Margin="15,15,15,10"/>

                <!-- Search Box -->
                <Grid Grid.Row="1" Margin="10,0,10,10">
                    <TextBox x:Name="NodeSearchBox"
                             Text="{Binding NodeSearchText, UpdateSourceTrigger=PropertyChanged}"
                             Background="#1E1E1E" Foreground="#CCC"
                             BorderThickness="1" BorderBrush="#3E3E42"
                             Padding="8,6" FontSize="11"/>
                    <TextBlock Text="Search nodes..." Foreground="#666" FontSize="11"
                               IsHitTestVisible="False" Margin="10,7,0,0"
                               Visibility="{Binding NodeSearchText, Converter={StaticResource NullOrEmptyToVisibilityConverter}}"/>
                </Grid>

                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <!-- Source Nodes -->
                        <TextBlock Text="SOURCES" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,0,0,8"/>
                        <Button Content="Video Source"
                                Command="{Binding AddSourceNodeCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Resize Filters -->
                        <TextBlock Text="RESIZE" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="Resize (Lanczos)"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="resize"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Descale"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="descale"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="FmtConv"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="fmtconv"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Denoise Filters -->
                        <TextBlock Text="DENOISE" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="BM3D"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="bm3d"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="DFTTest"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="dfttest"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="KNLMeansCL"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="knlm"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Bilateral"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="bilateral"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Deinterlace Filters -->
                        <TextBlock Text="DEINTERLACE" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="EEDI3"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="eedi3"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="NNEDI3"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="nnedi3"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Sharpen Filters -->
                        <TextBlock Text="SHARPEN" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="CAS"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="cas"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="TCanny"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="tcanny"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Utility Filters -->
                        <TextBlock Text="UTILITY" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="Crop"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="crop"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Trim"
                                Command="{Binding AddFilterNodeCommand}"
                                CommandParameter="trim"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Output Nodes -->
                        <TextBlock Text="OUTPUT" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="Output"
                                Command="{Binding AddOutputNodeCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Edit Actions -->
                        <TextBlock Text="EDIT" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,20,0,8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0" Content="Undo"
                                    Command="{Binding UndoCommand}"
                                    IsEnabled="{Binding CanUndo}"
                                    ToolTip="Undo (Ctrl+Z)"
                                    Style="{StaticResource SecondaryButton}"
                                    Margin="0,0,2,4"/>
                            <Button Grid.Column="1" Content="Redo"
                                    Command="{Binding RedoCommand}"
                                    IsEnabled="{Binding CanRedo}"
                                    ToolTip="Redo (Ctrl+Y)"
                                    Style="{StaticResource SecondaryButton}"
                                    Margin="2,0,0,4"/>
                        </Grid>

                        <!-- Graph Actions -->
                        <TextBlock Text="GRAPH" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,10,0,8"/>
                        <Button Content="Save Graph"
                                Command="{Binding SaveGraphCommand}"
                                ToolTip="Save Graph (Ctrl+S)"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Load Graph"
                                Command="{Binding LoadGraphCommand}"
                                ToolTip="Load Graph (Ctrl+O)"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Clear Canvas"
                                Command="{Binding ClearCanvasCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>

                        <!-- Script Actions -->
                        <TextBlock Text="SCRIPT" FontSize="10" FontWeight="Bold"
                                   Foreground="#888" Margin="5,15,0,8"/>
                        <Button Content="Generate Script"
                                Command="{Binding GenerateScriptCommand}"
                                Style="{StaticResource PrimaryButton}"
                                HorizontalAlignment="Stretch" Margin="0,0,0,4"/>
                        <Button Content="Save Script"
                                Command="{Binding SaveScriptCommand}"
                                Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch"/>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- GridSplitter between Palette and Canvas -->
        <GridSplitter Grid.Column="1" Width="5"
                      HorizontalAlignment="Stretch"
                      Background="Transparent"
                      Cursor="SizeWE"/>

        <!-- Center: Node Canvas -->
        <Border Grid.Column="2" Background="#1E1E1E" CornerRadius="8">
            <Grid>
                <nodify:NodifyEditor ItemsSource="{Binding Nodes}"
                                     Connections="{Binding Connections}"
                                     SelectedItem="{Binding SelectedNode}"
                                     ConnectionCompletedCommand="{Binding ConnectionCompletedCommand}"
                                     DisconnectConnectorCommand="{Binding ConnectionCompletedCommand}"
                                     Background="#1E1E1E"
                                     GridCellSize="20"
                                     ViewportZoom="{Binding ZoomLevel, Mode=TwoWay}"
                                     MinViewportZoom="0.25"
                                     MaxViewportZoom="2.0">
                <nodify:NodifyEditor.ItemContainerStyle>
                    <Style TargetType="{x:Type nodify:ItemContainer}">
                        <Setter Property="Location" Value="{Binding Location, Mode=TwoWay}"/>
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                    </Style>
                </nodify:NodifyEditor.ItemContainerStyle>
                <nodify:NodifyEditor.ConnectionTemplate>
                    <DataTemplate DataType="{x:Type vm:ConnectionViewModel}">
                        <nodify:Connection Source="{Binding Source.Anchor}"
                                           Target="{Binding Target.Anchor}"
                                           Stroke="#007ACC"
                                           StrokeThickness="2"/>
                    </DataTemplate>
                </nodify:NodifyEditor.ConnectionTemplate>
                <nodify:NodifyEditor.PendingConnectionTemplate>
                    <DataTemplate>
                        <nodify:PendingConnection Stroke="#007ACC"
                                                  StrokeThickness="2"
                                                  StrokeDashArray="2 1"/>
                    </DataTemplate>
                </nodify:NodifyEditor.PendingConnectionTemplate>
                </nodify:NodifyEditor>

                <!-- Zoom Controls Overlay -->
                <Border Background="#80252526" CornerRadius="4"
                        HorizontalAlignment="Right" VerticalAlignment="Bottom"
                        Margin="12" Padding="4">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="-" Command="{Binding ZoomOutCommand}"
                                Width="28" Height="28" FontSize="16" FontWeight="Bold"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"
                                ToolTip="Zoom Out"/>
                        <TextBlock Text="{Binding ZoomLevel, StringFormat={}{0:P0}}"
                                   Foreground="#CCC" FontSize="11"
                                   VerticalAlignment="Center" Margin="8,0"
                                   MinWidth="45" TextAlignment="Center"/>
                        <Button Content="+" Command="{Binding ZoomInCommand}"
                                Width="28" Height="28" FontSize="16" FontWeight="Bold"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"
                                ToolTip="Zoom In"/>
                        <Rectangle Width="1" Fill="#555" Margin="8,4"/>
                        <Button Content="1:1" Command="{Binding ResetZoomCommand}"
                                Padding="8,4" FontSize="10"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"
                                ToolTip="Reset Zoom"/>
                        <Button Content="Fit" Command="{Binding FitToViewCommand}"
                                Padding="8,4" FontSize="10" Margin="4,0,0,0"
                                Background="#3E3E42" Foreground="#CCC" BorderThickness="0"
                                ToolTip="Fit to View"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- GridSplitter between Canvas and Properties -->
        <GridSplitter Grid.Column="3" Width="5"
                      HorizontalAlignment="Stretch"
                      Background="Transparent"
                      Cursor="SizeWE"/>

        <!-- Right Panel: Properties, Script & Preview Tabs -->
        <Border Grid.Column="4" Background="#252526" CornerRadius="8">
            <TabControl Background="Transparent" BorderThickness="0" SelectedIndex="0">
                <TabControl.Resources>
                    <Style TargetType="TabItem">
                        <Setter Property="Background" Value="#252526"/>
                        <Setter Property="Foreground" Value="#999"/>
                        <Setter Property="Padding" Value="12,8"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Border x:Name="Border" Background="{TemplateBinding Background}"
                                            CornerRadius="4,4,0,0" Margin="2,0,0,0">
                                        <ContentPresenter x:Name="ContentSite"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Center"
                                                          ContentSource="Header"
                                                          Margin="{TemplateBinding Padding}"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#1E1E1E"/>
                                            <Setter Property="Foreground" Value="#F1F1F1"/>
                                            <Setter TargetName="Border" Property="Background" Value="#1E1E1E"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#333337"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.Resources>

                <!-- Properties Tab -->
                <TabItem Header="Properties">
                    <views:NodePropertiesPanel DataContext="{Binding}"/>
                </TabItem>

                <!-- Script Tab -->
                <TabItem Header="Script">
                    <Grid Background="#1E1E1E">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Background="#1E1E1E"
                                CornerRadius="0,0,4,4" Margin="0">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Auto">
                                <TextBox Text="{Binding GeneratedScript, Mode=OneWay}"
                                         IsReadOnly="True"
                                         Background="Transparent"
                                         Foreground="#D4D4D4"
                                         FontFamily="Consolas"
                                         FontSize="11"
                                         BorderThickness="0"
                                         Padding="10"
                                         TextWrapping="NoWrap"
                                         AcceptsReturn="True"/>
                            </ScrollViewer>
                        </Border>

                        <TextBlock Grid.Row="1"
                                   Text="{Binding StatusMessage}"
                                   Foreground="#999"
                                   FontSize="11"
                                   Margin="10,5,10,10"/>
                    </Grid>
                </TabItem>

                <!-- Preview Tab -->
                <TabItem Header="Preview">
                    <Grid Background="#1E1E1E">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Preview Image -->
                        <Border Grid.Row="0" Background="#0A0A0A" Margin="8">
                            <Grid>
                                <!-- Preview Frame -->
                                <Image Source="{Binding PreviewFrame}"
                                       Stretch="Uniform"
                                       RenderOptions.BitmapScalingMode="HighQuality"/>

                                <!-- Loading Indicator -->
                                <Border Background="#80000000" CornerRadius="4"
                                        Visibility="{Binding IsPreviewGenerating, Converter={StaticResource BoolToVisibilityConverter}}"
                                        HorizontalAlignment="Center" VerticalAlignment="Center"
                                        Padding="16,8">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Generating..." Foreground="#FFF" FontSize="12"/>
                                    </StackPanel>
                                </Border>

                                <!-- No Preview Message -->
                                <TextBlock Text="Click Refresh or connect nodes to generate preview"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                           Foreground="#666" FontSize="11"
                                           Visibility="{Binding PreviewFrame, Converter={StaticResource NullToVisibilityConverter}}"/>
                            </Grid>
                        </Border>

                        <!-- Frame Slider -->
                        <Grid Grid.Row="1" Margin="8,0,8,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="Frame:" Foreground="#999" FontSize="11"
                                       VerticalAlignment="Center"/>
                            <Slider Grid.Column="1" Minimum="0" Maximum="1000"
                                    Value="{Binding PreviewFrameNumber}"
                                    TickFrequency="1" IsSnapToTickEnabled="True"
                                    Margin="8,0"/>
                            <TextBox Grid.Column="2" Text="{Binding PreviewFrameNumber, UpdateSourceTrigger=PropertyChanged}"
                                     Background="#1E1E1E" Foreground="#CCC"
                                     BorderThickness="1" BorderBrush="#3E3E42"
                                     Padding="4" FontSize="11"
                                     HorizontalContentAlignment="Center"/>
                        </Grid>

                        <!-- Preview Controls -->
                        <StackPanel Grid.Row="2" Orientation="Horizontal"
                                    HorizontalAlignment="Center" Margin="8,0,8,8">
                            <Button Content="Refresh" Command="{Binding RequestLivePreviewCommand}"
                                    Style="{StaticResource SecondaryButton}"
                                    Padding="12,6" Margin="0,0,8,0"/>
                            <ToggleButton Content="{Binding AutoPreviewEnabled, Converter={StaticResource BoolToToggleLabelConverter}}"
                                          IsChecked="{Binding AutoPreviewEnabled}"
                                          Style="{StaticResource ToggleButtonStyle}"
                                          Padding="12,6"/>
                        </StackPanel>
                    </Grid>
                </TabItem>
            </TabControl>
        </Border>
    </Grid>
</UserControl>
