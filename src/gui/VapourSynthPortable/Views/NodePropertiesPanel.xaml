<UserControl x:Class="VapourSynthPortable.Views.NodePropertiesPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:VapourSynthPortable.ViewModels.NodeEditor"
             xmlns:models="clr-namespace:VapourSynthPortable.Models.NodeModels"
             xmlns:helpers="clr-namespace:VapourSynthPortable.Helpers">

    <UserControl.Resources>
        <!-- Float Parameter Template with Slider -->
        <DataTemplate x:Key="FloatParameterTemplate" DataType="{x:Type models:NodeParameter}">
            <StackPanel Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Name}" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                    <Button Grid.Column="1" Content="Reset" FontSize="9" Padding="6,2"
                            Command="{Binding DataContext.ResetParameterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="#3E3E42" Foreground="#999" BorderThickness="0"
                            Visibility="{Binding DefaultValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                </Grid>
                <Grid Margin="0,4,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="60"/>
                    </Grid.ColumnDefinitions>
                    <Slider Minimum="{Binding MinValue}" Maximum="{Binding MaxValue}"
                            Value="{Binding Value, Converter={StaticResource StringToDoubleConverter}}"
                            TickFrequency="0.1" IsSnapToTickEnabled="False"
                            Background="#3E3E42" Foreground="#007ACC"/>
                    <TextBox Grid.Column="1" Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                             Background="#1E1E1E" Foreground="#CCC"
                             BorderThickness="1" BorderBrush="#3E3E42"
                             Padding="4" FontSize="11" Margin="8,0,0,0"
                             HorizontalContentAlignment="Right"/>
                </Grid>
                <TextBlock Text="{Binding Description}" Foreground="#666" FontSize="10"
                           TextWrapping="Wrap" Margin="0,2,0,0"
                           Visibility="{Binding Description, Converter={StaticResource NullToVisibilityConverter}}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Integer Parameter Template -->
        <DataTemplate x:Key="IntegerParameterTemplate" DataType="{x:Type models:NodeParameter}">
            <StackPanel Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Name}" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                    <Button Grid.Column="1" Content="Reset" FontSize="9" Padding="6,2"
                            Command="{Binding DataContext.ResetParameterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="#3E3E42" Foreground="#999" BorderThickness="0"
                            Visibility="{Binding DefaultValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                </Grid>
                <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,0"
                         Background="#1E1E1E" Foreground="#CCC"
                         BorderThickness="1" BorderBrush="#3E3E42"
                         Padding="8,6" FontSize="12"/>
                <TextBlock Text="{Binding Description}" Foreground="#666" FontSize="10"
                           TextWrapping="Wrap" Margin="0,2,0,0"
                           Visibility="{Binding Description, Converter={StaticResource NullToVisibilityConverter}}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Boolean Parameter Template -->
        <DataTemplate x:Key="BooleanParameterTemplate" DataType="{x:Type models:NodeParameter}">
            <StackPanel Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <CheckBox IsChecked="{Binding Value, Converter={StaticResource StringToBooleanConverter}}"
                              Foreground="#CCC" FontSize="11">
                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                    </CheckBox>
                    <Button Grid.Column="1" Content="Reset" FontSize="9" Padding="6,2"
                            Command="{Binding DataContext.ResetParameterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="#3E3E42" Foreground="#999" BorderThickness="0"
                            Visibility="{Binding DefaultValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                </Grid>
                <TextBlock Text="{Binding Description}" Foreground="#666" FontSize="10"
                           TextWrapping="Wrap" Margin="0,2,0,0"
                           Visibility="{Binding Description, Converter={StaticResource NullToVisibilityConverter}}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Choice Parameter Template -->
        <DataTemplate x:Key="ChoiceParameterTemplate" DataType="{x:Type models:NodeParameter}">
            <StackPanel Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Name}" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                    <Button Grid.Column="1" Content="Reset" FontSize="9" Padding="6,2"
                            Command="{Binding DataContext.ResetParameterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="#3E3E42" Foreground="#999" BorderThickness="0"
                            Visibility="{Binding DefaultValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                </Grid>
                <ComboBox SelectedItem="{Binding Value}" ItemsSource="{Binding Choices}" Margin="0,4,0,0"
                          Background="#1E1E1E" Foreground="#CCC" FontSize="12"/>
                <TextBlock Text="{Binding Description}" Foreground="#666" FontSize="10"
                           TextWrapping="Wrap" Margin="0,2,0,0"
                           Visibility="{Binding Description, Converter={StaticResource NullToVisibilityConverter}}"/>
            </StackPanel>
        </DataTemplate>

        <!-- String Parameter Template (Default) -->
        <DataTemplate x:Key="StringParameterTemplate" DataType="{x:Type models:NodeParameter}">
            <StackPanel Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Name}" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                    <Button Grid.Column="1" Content="Reset" FontSize="9" Padding="6,2"
                            Command="{Binding DataContext.ResetParameterCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="#3E3E42" Foreground="#999" BorderThickness="0"
                            Visibility="{Binding DefaultValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                </Grid>
                <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,0"
                         Background="#1E1E1E" Foreground="#CCC"
                         BorderThickness="1" BorderBrush="#3E3E42"
                         Padding="8,6" FontSize="12"/>
                <TextBlock Text="{Binding Description}" Foreground="#666" FontSize="10"
                           TextWrapping="Wrap" Margin="0,2,0,0"
                           Visibility="{Binding Description, Converter={StaticResource NullToVisibilityConverter}}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Parameter Template Selector -->
        <helpers:ParameterTemplateSelector x:Key="ParameterTemplateSelector"
                                           FloatTemplate="{StaticResource FloatParameterTemplate}"
                                           IntegerTemplate="{StaticResource IntegerParameterTemplate}"
                                           BooleanTemplate="{StaticResource BooleanParameterTemplate}"
                                           ChoiceTemplate="{StaticResource ChoiceParameterTemplate}"
                                           StringTemplate="{StaticResource StringParameterTemplate}"/>
    </UserControl.Resources>

    <Grid>
        <!-- No Selection State -->
        <Border x:Name="NoSelectionPanel" Background="#252526" CornerRadius="4"
                Visibility="{Binding SelectedNode, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Invert}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="No Node Selected" FontSize="14" Foreground="#666"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Select a node to view its properties" FontSize="11" Foreground="#555"
                           HorizontalAlignment="Center" Margin="0,8,0,0"/>
            </StackPanel>
        </Border>

        <!-- Properties Panel -->
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      Visibility="{Binding SelectedNode, Converter={StaticResource NullToVisibilityConverter}}">
            <StackPanel Margin="12">
                <!-- Node Header -->
                <Border Background="#2D2D30" CornerRadius="4" Padding="12" Margin="0,0,0,12">
                    <StackPanel>
                        <TextBlock Text="{Binding SelectedNode.Title}"
                                   FontSize="16" FontWeight="SemiBold" Foreground="#F1F1F1"/>
                        <TextBlock Text="{Binding SelectedNode.NodeType}"
                                   FontSize="11" Foreground="#888" Margin="0,4,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Source Node Properties -->
                <StackPanel Visibility="{Binding IsSourceNodeSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="SOURCE SETTINGS" FontSize="10" FontWeight="Bold"
                               Foreground="#888" Margin="0,0,0,10"/>

                    <StackPanel Margin="0,0,0,12">
                        <TextBlock Text="File Path" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                        <Grid Margin="0,4,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Text="{Binding SourceFilePath, UpdateSourceTrigger=PropertyChanged}"
                                     Background="#1E1E1E" Foreground="#CCC"
                                     BorderThickness="1" BorderBrush="#3E3E42"
                                     Padding="8,6" FontSize="11"/>
                            <Button Grid.Column="1" Content="..."
                                    Command="{Binding BrowseSourceFileCommand}"
                                    Width="30" Margin="4,0,0,0"
                                    Background="#3E3E42" Foreground="#CCC" BorderThickness="0"/>
                        </Grid>
                    </StackPanel>

                    <StackPanel Margin="0,0,0,12">
                        <TextBlock Text="Source Plugin" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                        <ComboBox SelectedItem="{Binding SourcePlugin}" Margin="0,4,0,0"
                                  Background="#1E1E1E" Foreground="#CCC" FontSize="12">
                            <ComboBoxItem Content="ffms2"/>
                            <ComboBoxItem Content="lsmashsource"/>
                        </ComboBox>
                    </StackPanel>
                </StackPanel>

                <!-- Filter Node Properties -->
                <StackPanel Visibility="{Binding IsFilterNodeSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="PARAMETERS" FontSize="10" FontWeight="Bold" Foreground="#888"/>
                        <Button Grid.Column="1" Content="Reset All" FontSize="9" Padding="8,4"
                                Command="{Binding ResetAllParametersCommand}"
                                Background="#3E3E42" Foreground="#999" BorderThickness="0"/>
                    </Grid>

                    <ItemsControl ItemsSource="{Binding FilterParameters}"
                                  ItemTemplateSelector="{StaticResource ParameterTemplateSelector}"/>
                </StackPanel>

                <!-- Output Node Properties -->
                <StackPanel Visibility="{Binding IsOutputNodeSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TextBlock Text="OUTPUT SETTINGS" FontSize="10" FontWeight="Bold"
                               Foreground="#888" Margin="0,0,0,10"/>

                    <StackPanel Margin="0,0,0,12">
                        <TextBlock Text="Output Index" Foreground="#CCC" FontSize="11" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding OutputIndex, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,0"
                                 Background="#1E1E1E" Foreground="#CCC"
                                 BorderThickness="1" BorderBrush="#3E3E42"
                                 Padding="8,6" FontSize="12"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
